---
title: PE 파일
date: 2020-11-15 17:07:37
tags:
- PE
category:
- Windows
---

## PE

윈도우 기반 운영체제에서 사용하는 실행파일 형식으로 UNIX의 COFF(Common Object File Format)을 기반으로 한다. 가상 메모리 주소 공간에 PE Loader가 PE 파일을 가지고 메모리에 알맞게 배치하며 프로그램 유형, 동작등에 맞쳐서 알맞게 로드해준다.
64비트는 PE32+이다.

### 가상 메모리

운영체제에서 사용하는 논리적 메모리,  모든 프로세스는 각자 하나의 가상 메모리를 가지고 있다. 실제 물리 메모리 주소와 가상 주소를 매핑한 후 해당 영역을 사용
메모리는 사용자 영역과 커널 영역으로 나뉘며 서로 침범을 못한다.

### RVA(Relative Virtual Address) , VA

![RVA,VA](/img/rva.PNG)

가상주소(VA) = ImageBase + RVA


## PE 구조

![PE](/img/pe.PNG)

### IMAGE_DOS_HEADER

|종류|의미|
|:---:|:---|
|e_magic | "MZ"(4D5A)|
|e_lfanew | IMAGE_NT_HEADERS 시작주소|

### IMAGE_NT_HEADERS

|종류|의미|
|:---:|:---|
|Signature | "PE"|
|FileHeader | IMAGE_FILE_HEADER(20byte)|
|OptionalHeader | IMAGE_OPTIONAL_HEADER(224byte)|

#### IMAGE_FILE_HEADER(20Byte)

|종류|의미|
|:---:|:---|
|Machine | CPU 아키텍쳐|
|NumberOfSections | 섹션|
|TimeDateStamp | 파일이 만들어진 시간|
|SizeOfOptionalHeader | IMAGE_OPTIONAL_HEADER 구조체 바이트 수|

#### IMAGE_OPTIONAL_HEADER(224Byte)

|종류|의미|
|:---:|:---|
| Magic | 32bit or 64bit|
| AddressOfEntryPoint | 최초로 실행되는 코드의 시작 주소|
| ImageBase | PE 파일이 로딩되는 시작 주소|
| SectionAlignment | 메모리의 섹션 최소 단위|
| FileAlignment | 파일의 섹션 최소 단위|
| SizeOfImage | 메모리 로딩 시 차지하는 PE 파일 크기|
| SizeOfHeaders | PE 헤더의 전체 크기|
| Subsystem | 파일 종류(드라이버/실행 파일)|
| DllCharacteristics |ASLR, DEP, SEH, Signing 관련속성 |
| NumberOfRvaAndSizes |DataDirectory배열 개수|

#### IMAGE_SECTION_HEADERS

|종류|의미|
|:---:|:---|
| Name | 섹션이름 |
| VirtualSize | 메모리에서 섹션 크기|
| VirtualAddress | 메모리에서 섹션 주소|
| SizeOfRawData | 파일에서 섹션 크기|
| PointerToRawData | 파일에서 섹션의 시작위치|
- Section : 프로그램의 실제 내용을 담고 있는 블럭
- 권한 : rwx
- 섹션 종류
   |섹션|의미|
   |:---:|:---|
   |.text | 프로그램의 코드 부분|
   |.data | 일기/쓰기 데이터 (전역 변수)|
   |.bss | 초기화 되지 않은 데이터|
   |.rsrc | 프로그램에서 사용하는 리소스(아이콘, 추가 바이너리)|
   |.idata | IAT 정보( 실제로는 .text 또는 .rdata에 있다)|
   | .edata | Export 정보|
   |.reloc | 재배치정보|

### File <-> MEM

- File = 메모리 섹션의 주소 - 데이터 주소 + 파일 섹션의 주소
- MEM = 파일 섹션 주소 - 데이터 주소 + 메모리 섹션의 주소
