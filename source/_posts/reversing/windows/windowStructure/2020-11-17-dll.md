---
title: DLL
date: 2020-11-17 01:56:31
tags:
- DLL
- IAT
category:
- Windows
---

## 라이브러리(Static Linking)

- 다른 프로그램과의 연결을 위해 존재, 서브 루틴이나 함수들이 저장된 파일의 모음
- 운영체제의 기능이 필요한 경우 프로그램에 라이브러리 파일을 포함해 빌드해야함

## DLL 

동적으로 연결할 수 있는 라이브러리

#### 명시적 링킹(Explict)

- 프로그램에서 필요한 순간에 DLL+함수 정보를 로드 후 해제
- 명시적 링킹은 LoadLibrary() 함수 와 GetProcAddress()함수를 사용하여 동적으로 프로세스 메모리 공간에 DLL과 함수를 프로그램 실행 도중에 불러온다. Dll Injection에도 사용하는 방법이다.

#### 암시적 링킹 (Implict)

- PE 파일 자체에 사용하는 DLL+ 함수 정보를 포함 후 프로그램 실행시 로드

## IAT

명시적 링킹 방법으로 프로그램이 함수 호출 시 필요한 함수 주소 목록을 담고 있는 테이블

```c++
typedef struct _IMAGE_IMPORT_DESCRIPTOR{
	union{
		DWORD Characteristics;
		DWORD OriginalFirstThunk;   
	}
	DWORD TimeDataStamp;
	DWORD ForwarderChain;
	DWORD Name;
	DWORD FirstThunk;
} IMAGE_IMPORT_DESCRIPTOR;

typedef struct _IMAGE_IMPORT_BY_NAME{
	WORD Hint;
	BYTE Name[1];
} IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;
```

- OriginalFirstThunk : [INT]Import Name Table 주소
- Name : 라이브러리 이름 문자열 주소
- FirstThunk : [IAT]Import Address Table 주소
- Hint : 서수
- Name[1] : 함수 이름 문자열

### DLL 가져오는 순서

![IAT](/img/IAT.PNG)


1. DataDirectory[1] 
1. IMAGE_DIRECTORY_ENTRY_IMPORT.VirtualAddress : DLL마다 정보를 가진 구조체 주소
1. IMAGE_IMPORT_DESCRIPTOR.Name : "user32.dll","kernel32.dll"등 dll이름
1. IMAGE_IMPORT_DESCRIPTOR.OriginFirstThunk -> INT : INT는 DLL의 API이름 목록을 가지고 있다.(Hint: 서수도 사용)
1. IMAGE_IMPORT_DESCRIPTOR.FirstThunk -> IAT : IAT는 DLL의 API함수 주소를 가지고 있다.
1. INT에서 본 이름과 서수로 IAT에서 함수 주소를 찾는다.
